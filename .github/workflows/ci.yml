name: ci
on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup NuGet
        uses: nuget/setup-nuget@v2
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Restore & Build (.sln or .csproj)
        shell: pwsh
        run: |
          Write-Host "=== Scan repo for .sln / .csproj ==="
          $solutions = Get-ChildItem -Recurse -Filter *.sln | Select-Object -Expand FullName
          $projects  = Get-ChildItem -Recurse -Filter *.csproj | Select-Object -Expand FullName
          Write-Host "Found solutions:`n$($solutions -join "`n")"
          Write-Host "Found projects :`n$($projects -join "`n")"

          if ($solutions) {
            foreach ($sln in $solutions) {
              nuget restore "$sln"
              msbuild "$sln" /p:Configuration=Release /m
            }
            exit 0
          }

          if ($projects) {
            foreach ($csproj in $projects) {
              nuget restore "$csproj"
              msbuild "$csproj" /p:Configuration=Release /m
            }
            exit 0
          }

          Write-Error "No .sln or .csproj found in repository."
          exit 1
  
  unit_tests:
    needs: build
    runs-on: windows-latest
    env:
      COV_MIN: 18
    steps:
      - uses: actions/checkout@v4
      - uses: microsoft/setup-msbuild@v2
  
      - name: Build tests (Debug with PDB)
        shell: pwsh
        run: |
          # 1) Restore cho c√°c project ki·ªÉu packages.config trong .sln
          nuget restore FoodOrderingSystem.sln
      
          # 2) Restore chu·∫©n cho c√°c project d√πng PackageReference TRONG .sln (n·∫øu c√≥)
          msbuild FoodOrderingSystem.sln -t:Restore
      
          # 3) ***Restore RI√äNG cho project test*** (v√¨ d√πng PackageReference / c√≥ th·ªÉ kh√¥ng n·∫±m trong .sln)
          msbuild ".\FoodOrderingSystem.Tests\FoodOrderingSystem.Tests.csproj" -t:Restore
      
          # 4) Build solution Debug + PDB full
          msbuild FoodOrderingSystem.sln `
            /p:Configuration=Debug `
            /p:DebugSymbols=true `
            /p:DebugType=Full `
            /m
      
          # 5) Build ri√™ng project test ƒë·ªÉ ch·∫Øc ch·∫Øn sinh DLL + PDB
          msbuild ".\FoodOrderingSystem.Tests\FoodOrderingSystem.Tests.csproj" `
            /p:Configuration=Debug `
            /p:DebugSymbols=true `
            /p:DebugType=Full `
            /m
      
          # 6) In ra PDB ƒë·ªÉ ki·ªÉm tra
          Get-ChildItem -Recurse ".\FoodOrderingSystem.Tests\bin\Debug" -Filter *.pdb | Select-Object FullName

  
      # T√¨m vstest.console.exe (VS)
      - name: Locate VSTest
        id: vs
        shell: pwsh
        run: |
          $vsPath = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -products * -requires Microsoft.VisualStudio.PackageGroup.TestTools.Core -property installationPath
          if (-not $vsPath) { throw "Cannot find Visual Studio" }
          $vstest = Join-Path $vsPath "Common7/IDE/Extensions/TestPlatform/vstest.console.exe"
          echo "vstest=$vstest" >> $env:GITHUB_OUTPUT
  
      # C√†i OpenCover + ReportGenerator
      - name: Install OpenCover & ReportGenerator
        shell: pwsh
        run: |
          choco install opencover.portable -y
          $rgOk = $true
          try { choco install reportgenerator.portable -y } catch { $rgOk = $false }
          if (-not (Get-Command reportgenerator -ErrorAction SilentlyContinue)) {
            dotnet tool install -g dotnet-reportgenerator-globaltool
            "$env:USERPROFILE\.dotnet\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          }
  
      # Ch·∫°y test qua OpenCover (L∆ØU √ù: -targetargs ph·∫£i l√† 1 chu·ªói ƒë∆∞·ª£c quote)
      - name: Run UNIT tests with coverage (OpenCover)
        shell: pwsh
        run: |
          $oc = (Get-Command OpenCover.Console.exe -ErrorAction SilentlyContinue).Source
          if (-not $oc) { $oc = Join-Path $env:ChocolateyInstall 'lib\opencover.portable\tools\OpenCover.Console.exe' }
          if (-not (Test-Path $oc)) { throw "OpenCover not found at: $oc" }
  
          $bin = Resolve-Path ".\FoodOrderingSystem.Tests\bin"
          # ∆Øu ti√™n Debug r·ªìi m·ªõi Release
          $testDll = Get-ChildItem -Recurse -Path $bin -Filter FoodOrderingSystem.Tests.dll |
                     Sort-Object { if ($_.FullName -match '\\bin\\Debug\\') {0} else {1} } |
                     Select-Object -First 1
          if (-not $testDll) { throw "Kh√¥ng t√¨m th·∫•y FoodOrderingSystem.Tests.dll" }
  
          New-Item -ItemType Directory -Force -Path "$PWD\out\unit-results" | Out-Null
  
          # GHI CH√ö: d√πng +[*]* ƒë·ªÉ tr√°nh l·ªçc nh·∫ßm khi·∫øn coverage = 0%; sau khi OK th√¨ si·∫øt l·∫°i th√†nh +[FoodOrderingSystem*]* n·∫øu mu·ªën
          & $oc -register:user `
            -returntargetcode `
            -target:"${{ steps.vs.outputs.vstest }}" `
            -targetargs:"`"$($testDll.FullName)`" /Logger:trx /ResultsDirectory:`"$PWD\out\unit-results`"" `
            -output:"unit-coverage.xml" `
            -filter:"+[*]* -[*.Tests*]*"
  
          # Xu·∫•t HTML + Cobertura.xml
          reportgenerator -reports:"unit-coverage.xml" -targetdir:"unit-coveragereport" -reporttypes:"Html;Cobertura"
      - name: Enforce coverage threshold
        if: github.event_name == 'pull_request'
        shell: pwsh
        run: |
          $min = [double](${env:COV_MIN} ?? 60)
          $cob = Join-Path $PWD "unit-coveragereport\Cobertura.xml"
          if (-not (Test-Path $cob)) { throw "Coverage file not found: $cob" }
          [xml]$x = Get-Content $cob
          $pct = [math]::Round([double]$x.coverage.'line-rate' * 100, 2)
          Write-Host "Line coverage: $pct % (min: $min %)"
          if ($pct -lt $min) { throw "Coverage below threshold ($min%). Current: $pct%" }

  
      - name: Upload unit results & coverage
        uses: actions/upload-artifact@v4
        with:
          name: unit-results-and-coverage
          path: |
            out/unit-results/*.trx
            unit-coverage.xml
            unit-coveragereport/**


  integration_tests:
    if: github.event_name == 'push'   # ch·ªâ ch·∫°y khi push/merge v√†o main
    needs: build
    runs-on: windows-latest
  
    steps:
      - uses: actions/checkout@v4
      - uses: microsoft/setup-msbuild@v2
      - uses: actions/setup-dotnet@v4        # ƒë·ªÉ d√πng l·ªánh dotnet (SDK)
        with:
          dotnet-version: '9.x'
  
      - name: Build (Release) for integration tests
        shell: pwsh
        run: |
          # Restore cho solution ki·ªÉu packages.config (n·∫øu c√≥)
          nuget restore
          msbuild FoodOrderingSystem.sln -t:Restore
  
          # üëâ Restore RI√äNG cho project test (SDK-style)
          dotnet restore .\FoodOrderingSystem.Tests\FoodOrderingSystem.Tests.csproj
  
          # Build solution Release
          msbuild FoodOrderingSystem.sln /p:Configuration=Release /m
  
          # Build ri√™ng project test ƒë·ªÉ ch·∫Øc ch·∫Øn c√≥ DLL
          msbuild .\FoodOrderingSystem.Tests\FoodOrderingSystem.Tests.csproj /p:Configuration=Release /m

  
      # 2) SQL LocalDB + seed schema
      - name: Prepare SQL LocalDB and seed schema
        shell: pwsh
        run: |
          sqllocaldb start "MSSQLLocalDB" | Out-Null
          sqlcmd -S "(localdb)\MSSQLLocalDB" -Q "IF DB_ID('OnlineFoodDB') IS NULL CREATE DATABASE [OnlineFoodDB]"
          sqlcmd -S "(localdb)\MSSQLLocalDB" -d "OnlineFoodDB" -i "onlinefoodscript.sql"
  
      # 3) T√¨m ƒë∆∞·ªùng d·∫´n VSTest
      - name: Locate VSTest
        id: vs
        shell: pwsh
        run: |
          $vsPath = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" `
                      -latest -products * `
                      -requires Microsoft.VisualStudio.PackageGroup.TestTools.Core `
                      -property installationPath
          if (-not $vsPath) { throw "Cannot find Visual Studio" }
          $vstest = Join-Path $vsPath "Common7/IDE/Extensions/TestPlatform/vstest.console.exe"
          "vstest=$vstest" >> $env:GITHUB_OUTPUT
  
      # 4) T√¨m DLL test linh ho·∫°t (∆∞u ti√™n Release; fallback Debug; m·ªçi TFM)
      - name: Locate test DLL (prefer Release, fallback Debug)
        id: finddll
        shell: pwsh
        run: |
          $bin = Resolve-Path ".\FoodOrderingSystem.Tests\bin"
          $candidates = Get-ChildItem -Recurse -Path $bin -Filter FoodOrderingSystem.Tests.dll -File |
                        Where-Object { $_.FullName -match '\\bin\\(Release|Debug)\\' }
          if (-not $candidates) {
            Write-Host "Kh√¥ng th·∫•y DLL trong $bin. In c√¢y th∆∞ m·ª•c ƒë·ªÉ debug:"
            Get-ChildItem -Recurse ".\FoodOrderingSystem.Tests\bin" | Select-Object FullName
            throw "FoodOrderingSystem.Tests.dll not found"
          }
          $dll = $candidates | Where-Object { $_.FullName -match '\\bin\\Release\\' } | Select-Object -First 1
          if (-not $dll) { $dll = $candidates | Where-Object { $_.FullName -match '\\bin\\Debug\\' } | Select-Object -First 1 }
          "dll=$($dll.FullName)" >> $env:GITHUB_OUTPUT
          Write-Host "Using test DLL: $($dll.FullName)"
  
      # 5) Ch·∫°y INTEGRATION tests v·ªõi DLL v·ª´a t√¨m
      - name: Run INTEGRATION tests
        shell: pwsh
        run: |
          $dll = "${{ steps.finddll.outputs.dll }}"
          if (-not (Test-Path $dll)) { throw "Kh√¥ng t√¨m th·∫•y DLL test: $dll" }
  
          New-Item -ItemType Directory -Force -Path "$PWD\out\integration-results" | Out-Null
          & "${{ steps.vs.outputs.vstest }}" "`"$dll`"" /Logger:trx `
            /ResultsDirectory:"$PWD\out\integration-results" `
            /TestCaseFilter:"TestCategory=Integration"
  
      - name: Upload integration results
        uses: actions/upload-artifact@v4
        with:
          name: integration-results
          path: out/integration-results/*.trx


  package:
    needs: [unit_tests]         # ch·ªâ package khi unit pass; mu·ªën ch·ªâ khi push th√¨ th√™m ƒëi·ªÅu ki·ªán if
    runs-on: windows-latest
    if: ${{ success() }}
    steps:
      - uses: actions/checkout@v4
      - uses: microsoft/setup-msbuild@v2
      - uses: nuget/setup-nuget@v2

      - name: Restore NuGet (packages.config)
        shell: pwsh
        run: |
          nuget restore .\FoodOrderingSystem.sln -NonInteractive
          # ƒë·∫£m b·∫£o g√≥i CodeDom c√≥ m·∫∑t (ph√≤ng khi nuget restore b·ªè s√≥t)
          if (-not (Test-Path ".\packages\Microsoft.CodeDom.Providers.DotNetCompilerPlatform.2.0.0\build\net46\Microsoft.CodeDom.Providers.DotNetCompilerPlatform.props")) {
            nuget install Microsoft.CodeDom.Providers.DotNetCompilerPlatform -Version 2.0.0 -OutputDirectory packages
          }
      - name: Package Web App (WebDeploy zip)
        shell: pwsh
        run: |
          $proj = Get-ChildItem -Recurse -Filter FoodOrderingSystem.csproj | Select-Object -First 1 -Expand FullName
          if (-not $proj) { throw "Kh√¥ng t√¨m th·∫•y FoodOrderingSystem.csproj" }
          msbuild $proj `
            /p:Configuration=Release `
            /p:DeployOnBuild=true `
            /p:WebPublishMethod=Package `
            /p:PackageAsSingleFile=true `
            /p:PackageLocation="$PWD\out\FoodOrderingSystem.zip"
      - name: Upload deploy artifact
        uses: actions/upload-artifact@v4
        with:
          name: webdeploy-package
          path: out/FoodOrderingSystem.zip
