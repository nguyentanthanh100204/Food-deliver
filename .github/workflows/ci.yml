name: ci
on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup NuGet
        uses: nuget/setup-nuget@v2
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Restore & Build (.sln or .csproj)
        shell: pwsh
        run: |
          Write-Host "=== Scan repo for .sln / .csproj ==="
          $solutions = Get-ChildItem -Recurse -Filter *.sln | Select-Object -Expand FullName
          $projects  = Get-ChildItem -Recurse -Filter *.csproj | Select-Object -Expand FullName
          Write-Host "Found solutions:`n$($solutions -join "`n")"
          Write-Host "Found projects :`n$($projects -join "`n")"

          if ($solutions) {
            foreach ($sln in $solutions) {
              nuget restore "$sln"
              msbuild "$sln" /p:Configuration=Release /m
            }
            exit 0
          }

          if ($projects) {
            foreach ($csproj in $projects) {
              nuget restore "$csproj"
              msbuild "$csproj" /p:Configuration=Release /m
            }
            exit 0
          }

          Write-Error "No .sln or .csproj found in repository."
          exit 1

  unit_tests:
    needs: build
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: microsoft/setup-msbuild@v2

      - name: Build tests (Debug for coverage)
        shell: pwsh
        run: |
          nuget restore FoodOrderingSystem.sln
          msbuild FoodOrderingSystem.sln -t:Restore
          msbuild .\FoodOrderingSystem.Tests\FoodOrderingSystem.Tests.csproj -t:Restore
          # ép dùng Windows PDB (không portable)
          msbuild .\FoodOrderingSystem\FoodOrderingSystem.csproj /p:Configuration=Debug /p:DebugType=full /p:DebugSymbols=true /m
          msbuild .\FoodOrderingSystem.Tests\FoodOrderingSystem.Tests.csproj /p:Configuration=Debug /p:DebugType=full /p:DebugSymbols=true /m


      - name: Locate VSTest
        id: vs
        shell: pwsh
        run: |
          $vsPath = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -products * -requires Microsoft.VisualStudio.PackageGroup.TestTools.Core -property installationPath
          if (-not $vsPath) { throw "Cannot find Visual Studio" }
          $vstest = Join-Path $vsPath "Common7/IDE/Extensions/TestPlatform/vstest.console.exe"
          echo "vstest=$vstest" >> $env:GITHUB_OUTPUT

      - name: Install ReportGenerator
        shell: pwsh
        run: |
          $ok = $true
          try { choco install reportgenerator.portable -y } catch { $ok = $false }
          if (-not (Get-Command reportgenerator -ErrorAction SilentlyContinue)) {
            dotnet tool install -g dotnet-reportgenerator-globaltool
            "$env:USERPROFILE\.dotnet\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          }
      - name: Install OpenCover & ReportGenerator
        shell: pwsh
        run: |
          choco install opencover.portable -y
          $ok = $true
          try { choco install reportgenerator.portable -y } catch { $ok = $false }
          if (-not (Get-Command reportgenerator -ErrorAction SilentlyContinue)) { $ok = $false }
          if (-not $ok) {
            dotnet tool install -g dotnet-reportgenerator-globaltool
            "$env:USERPROFILE\.dotnet\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          }


      - name: Run UNIT tests with coverage (OpenCover)
        shell: pwsh
        run: |
          # Resolve OpenCover path (ưu tiên Get-Command, fallback vào thư mục Chocolatey)
          $oc = (Get-Command OpenCover.Console.exe -ErrorAction SilentlyContinue).Source
          if (-not $oc) {
            $oc = Join-Path $env:ChocolateyInstall 'lib\opencover.portable\tools\OpenCover.Console.exe'
          }
          if (-not (Test-Path $oc)) { throw "OpenCover not found at: $oc" }

          # Tìm đúng DLL test (ưu tiên Release rồi Debug)
          $bin = Resolve-Path ".\FoodOrderingSystem.Tests\bin"
          $testDll = Get-ChildItem -Recurse -Path $bin -Filter FoodOrderingSystem.Tests.dll `
                      | Where-Object { $_.FullName -match '\\bin\\(Release|Debug)\\' } `
                      | Select-Object -First 1
          if (-not $testDll) { throw "Không tìm thấy FoodOrderingSystem.Tests.dll" }

          # Locate VSTest
          $vsPath = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" `
                    -latest -products * `
                    -requires Microsoft.VisualStudio.PackageGroup.TestTools.Core `
                    -property installationPath
          if (-not $vsPath) { throw "Không tìm thấy Visual Studio" }
          $vstest = Join-Path $vsPath "Common7/IDE/Extensions/TestPlatform/vstest.console.exe"

          New-Item -ItemType Directory -Force -Path "$PWD\out\unit-results" | Out-Null

          # CHẠY KHÔNG FILTER để chắc chắn có test chạy (nếu muốn lọc thì thêm lại /TestCaseFilter)
          & $oc -register:user `
            -target:"$vstest" `
            -targetargs:@($testDll.FullName, '/Logger:trx', "/ResultsDirectory:$PWD\out\unit-results") `
            -output:"unit-coverage.xml" `
            -filter:"+[FoodOrderingSystem*]* -[*.Tests*]*"

          reportgenerator -reports:"unit-coverage.xml" -targetdir:"unit-coveragereport" -reporttypes:"Html;TextSummary"


      - name: Enforce coverage threshold (60%)
        if: github.event_name == 'pull_request'
        shell: pwsh
        run: |
          if (-not (Test-Path "unit-coverage.xml")) { throw "Coverage file not found" }
          [xml]$cob = Get-Content "unit-coverage.xml"
          # Cobertura có thuộc tính line-rate (0..1)
          $seqp = [math]::Round([double]$cob.coverage.'line-rate' * 100, 2)
          Write-Host "Sequence coverage: $seqp %"
          if ($seqp -lt 60) { throw "Coverage below threshold (60%). Current: $seqp%" }


      - name: Upload unit results & coverage
        uses: actions/upload-artifact@v4
        with:
          name: unit-results-and-coverage
          path: |
            out/unit-results/*.trx
            unit-coverage.xml
            unit-coveragereport/**

  integration_tests:
    if: github.event_name == 'push'   # chỉ chạy khi push/merge vào main
    needs: build
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: microsoft/setup-msbuild@v2

      - name: Build tests (Release)
        run: |
          nuget restore
          msbuild FoodOrderingSystem.sln /p:Configuration=Release

      - name: Prepare SQL LocalDB and seed schema
        shell: pwsh
        run: |
          # Khớp với App.config của project test (mặc định dùng MSSQLLocalDB)
          sqllocaldb start "MSSQLLocalDB" | Out-Null
          sqlcmd -S "(localdb)\MSSQLLocalDB" -Q "IF DB_ID('OnlineFoodDB') IS NULL CREATE DATABASE [OnlineFoodDB]"
          sqlcmd -S "(localdb)\MSSQLLocalDB" -d "OnlineFoodDB" -i "onlinefoodscript.sql"

      - name: Locate VSTest
        id: vs
        shell: pwsh
        run: |
          $vsPath = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -products * -requires Microsoft.VisualStudio.PackageGroup.TestTools.Core -property installationPath
          $vstest = Join-Path $vsPath "Common7/IDE/Extensions/TestPlatform/vstest.console.exe"
          echo "vstest=$vstest" >> $env:GITHUB_OUTPUT

      - name: Run INTEGRATION tests
        shell: pwsh
        run: |
          $dll = Join-Path $PWD 'FoodOrderingSystem.Tests\bin\Release\net48\FoodOrderingSystem.Tests.dll'
          if (-not (Test-Path $dll)) {
            Write-Error "Không tìm thấy DLL test: $dll. Hãy kiểm tra bước build (đúng cấu hình Release chưa?)."
            exit 1
          }

          New-Item -ItemType Directory -Force -Path "$PWD\out\integration-results" | Out-Null

          & "${{ steps.vs.outputs.vstest }}" `
            "`"$dll`"" `
            /Logger:trx `
            /ResultsDirectory:"$PWD\out\integration-results" `
            /TestCaseFilter:"TestCategory=Integration"

      - name: Upload integration results
        uses: actions/upload-artifact@v4
        with:
          name: integration-results
          path: out/integration-results/*.trx

  package:
    needs: [unit_tests]         # chỉ package khi unit pass; muốn chỉ khi push thì thêm điều kiện if
    runs-on: windows-latest
    if: ${{ success() }}
    steps:
      - uses: actions/checkout@v4
      - uses: microsoft/setup-msbuild@v2
      - name: Package Web App (WebDeploy zip)
        shell: pwsh
        run: |
          $proj = Get-ChildItem -Recurse -Filter FoodOrderingSystem.csproj | Select-Object -First 1 -Expand FullName
          if (-not $proj) { throw "Không tìm thấy FoodOrderingSystem.csproj" }
          msbuild $proj `
            /p:Configuration=Release `
            /p:DeployOnBuild=true `
            /p:WebPublishMethod=Package `
            /p:PackageAsSingleFile=true `
            /p:PackageLocation="$PWD\out\FoodOrderingSystem.zip"
      - name: Upload deploy artifact
        uses: actions/upload-artifact@v4
        with:
          name: webdeploy-package
          path: out/FoodOrderingSystem.zip
