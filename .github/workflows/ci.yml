name: ci
on:
  pull_request:
  push:
    branches: [ main ]  

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup NuGet
        uses: nuget/setup-nuget@v2

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Restore & Build (.sln or .csproj)
        shell: pwsh
        run: |
          Write-Host "=== Scan repo for .sln / .csproj ==="
          $solutions = Get-ChildItem -Recurse -Filter *.sln | Select-Object -Expand FullName
          $projects  = Get-ChildItem -Recurse -Filter *.csproj | Select-Object -Expand FullName
          Write-Host "Found solutions:" ($solutions -join "`n")
          Write-Host "Found projects :" ($projects -join "`n")

          if ($solutions) {
            foreach ($sln in $solutions) {
              Write-Host "NuGet restore $sln"
              nuget restore "$sln"
              Write-Host "MSBuild $sln (Release)"
              msbuild "$sln" /p:Configuration=Release /m
            }
            exit 0
          }

          if ($projects) {
            foreach ($csproj in $projects) {
              Write-Host "NuGet restore $csproj"
              nuget restore "$csproj"
              Write-Host "MSBuild $csproj (Release)"
              msbuild "$csproj" /p:Configuration=Release /m
            }
            exit 0
          }

          Write-Error "No .sln or .csproj found in repository. Please commit your solution/project files."
          exit 1
      - name: Discover test assemblies
        id: find_tests
        shell: pwsh
        run: |
          Write-Host "=== Discover *Tests.dll ==="
          $dlls = Get-ChildItem -Recurse -Include *Tests.dll -Path . |
                  Where-Object { $_.FullName -notmatch "TestAdapter|obj\\|bin\\Debug" } |
                  Select-Object -Expand FullName
          if ($dlls) {
            "found=$($dlls -join '::')" | Out-File -Append $env:GITHUB_OUTPUT
            Write-Host "Found:`n$($dlls -join "`n")"
          } else {
            Write-Host "No *Tests.dll found"
          }
      - name: Prepare SQL LocalDB and seed schema
        shell: pwsh
        run: |
          sqllocaldb start "MSSQLLocalDB" | Out-Null

          # Tạo DB nếu chưa có
          sqlcmd -S "(localdb)\MSSQLLocalDB" -Q "IF DB_ID('OnlineFoodDB') IS NULL CREATE DATABASE [OnlineFoodDB]"

          # Áp script schema/data từ repo root
          sqlcmd -S "(localdb)\MSSQLLocalDB" -d "OnlineFoodDB" -i "onlinefoodscript.sql"

      - name: Run tests (VSTest)
        if: steps.find_tests.outputs.found != ''
        shell: pwsh
        run: |
          $assemblies = "${{ steps.find_tests.outputs.found }}".Split("::")
          # Tìm đường dẫn vstest.console.exe an toàn bằng vswhere (phòng trường hợp Enterprise/Community)
          $vswhere = "${Env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          $vstest = & $vswhere -latest -products * -requires Microsoft.Component.TestTools.BuildTools -find **\vstest.console.exe | Select-Object -First 1
          if (-not $vstest) { $vstest = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\IDE\CommonExtensions\Microsoft\TestWindow\vstest.console.exe" }
          Write-Host "Using vstest: $vstest"
          foreach ($asm in $assemblies) {
            & "$vstest" "$asm" --logger:"trx;LogFileName=$(Split-Path $asm -Leaf).trx"
          }

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: "**/*.trx"
      # ---- chỉ chạy nếu toàn bộ bước trước thành công ----
      - name: Package Web App (WebDeploy zip)
        if: ${{ success() }}
        shell: pwsh
        run: |
          # tìm file .csproj của web (đổi tên nếu dự án không phải FoodOrderingSystem.csproj)
          $proj = Get-ChildItem -Recurse -Filter FoodOrderingSystem.csproj | Select-Object -First 1 -Expand FullName
          if (-not $proj) { throw "Không tìm thấy FoodOrderingSystem.csproj" }

          # build + tạo gói WebDeploy (.zip)
          & msbuild $proj `
            /p:Configuration=Release `
            /p:DeployOnBuild=true `
            /p:WebPublishMethod=Package `
            /p:PackageAsSingleFile=true `
            /p:PackageLocation="$PWD\out\FoodOrderingSystem.zip"

      - name: Upload deploy artifact
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: webdeploy-package
          path: out/FoodOrderingSystem.zip
